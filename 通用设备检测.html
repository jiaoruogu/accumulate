<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é€šç”¨è¾“å…¥è®¾å¤‡æ£€æµ‹å™¨</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        min-height: 100vh;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }

      h1 {
        text-align: center;
        margin-bottom: 30px;
        font-size: 2.5em;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .device-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .device-section {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        border: 2px solid rgba(255, 255, 255, 0.2);
      }

      .device-section.active {
        border-color: #00ff00;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
      }

      .section-title {
        font-size: 1.5em;
        margin-bottom: 15px;
        text-align: center;
        color: #ffd700;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .status {
        text-align: center;
        font-size: 1em;
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 8px;
        background: rgba(255, 0, 0, 0.3);
      }

      .status.connected {
        background: rgba(0, 255, 0, 0.3);
      }

      /* æ¸¸æˆæ‰‹æŸ„æ ·å¼ */
      .button-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin-bottom: 15px;
      }

      .button {
        padding: 8px;
        border-radius: 6px;
        text-align: center;
        font-weight: bold;
        background: rgba(255, 255, 255, 0.2);
        transition: all 0.1s ease;
        font-size: 0.8em;
      }

      .button.pressed {
        background: #00ff00 !important;
        color: #000;
        transform: scale(1.05);
        box-shadow: 0 0 15px rgba(0, 255, 0, 0.6);
      }

      .stick-container {
        display: flex;
        justify-content: space-around;
        margin-top: 15px;
      }

      .stick-visual {
        width: 80px;
        height: 80px;
        border: 2px solid rgba(255, 255, 255, 0.5);
        border-radius: 50%;
        position: relative;
        background: rgba(0, 0, 0, 0.2);
      }

      .stick-dot {
        width: 12px;
        height: 12px;
        background: #00ff00;
        border-radius: 50%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        transition: all 0.1s ease;
      }

      /* é”®ç›˜/é¥æ§å™¨æ ·å¼ */
      .key-display {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        padding: 15px;
        min-height: 100px;
        font-family: "Courier New", monospace;
      }

      .current-key {
        font-size: 2em;
        color: #00ff00;
        text-align: center;
        margin-bottom: 10px;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
      }

      .key-info {
        font-size: 0.9em;
        text-align: center;
      }

      /* æ‰«ç æªæ ·å¼ */
      .scanner-input {
        width: 100%;
        padding: 15px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 1.1em;
        margin-bottom: 15px;
      }

      .scanner-input:focus {
        outline: none;
        border-color: #00ff00;
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
      }

      .scanner-result {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        padding: 15px;
        min-height: 80px;
        font-family: "Courier New", monospace;
      }

      .scan-entry {
        margin-bottom: 8px;
        padding: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        border-left: 4px solid #00ff00;
      }

      /* HIDè®¾å¤‡æ ·å¼ */
      .hid-info {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        padding: 15px;
        font-family: "Courier New", monospace;
        font-size: 0.9em;
      }

      .hid-device {
        margin-bottom: 10px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 6px;
      }

      /* æ—¥å¿—æ ·å¼ */
      .log {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        padding: 20px;
        max-height: 300px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 0.9em;
      }

      .log-entry {
        margin-bottom: 5px;
        padding: 5px;
        border-radius: 3px;
        background: rgba(255, 255, 255, 0.1);
        border-left: 4px solid;
      }

      .log-gamepad {
        border-left-color: #00ff00;
      }
      .log-keyboard {
        border-left-color: #ffd700;
      }
      .log-scanner {
        border-left-color: #ff6b6b;
      }
      .log-hid {
        border-left-color: #4ecdc4;
      }

      .controls {
        text-align: center;
        margin-bottom: 20px;
      }

      .btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        margin: 0 10px;
        transition: all 0.3s ease;
      }

      .btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ® é€šç”¨è¾“å…¥è®¾å¤‡æ£€æµ‹å™¨</h1>

      <div class="controls">
        <button class="btn" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        <button class="btn" onclick="requestHIDAccess()" id="hidBtn">
          è¯·æ±‚HIDè®¾å¤‡è®¿é—®æƒé™
        </button>
        <button class="btn" onclick="focusScanner()">èšç„¦æ‰«ç è¾“å…¥</button>
      </div>

      <div class="device-grid">
        <!-- æ¸¸æˆæ‰‹æŸ„ -->
        <div class="device-section" id="gamepad-section">
          <div class="section-title">ğŸ® æ¸¸æˆæ‰‹æŸ„</div>
          <div class="status" id="gamepad-status">æœªè¿æ¥</div>
          <div class="button-grid">
            <div class="button" id="button-0">A</div>
            <div class="button" id="button-1">B</div>
            <div class="button" id="button-2">X</div>
            <div class="button" id="button-3">Y</div>
            <div class="button" id="button-4">LB</div>
            <div class="button" id="button-5">RB</div>
            <div class="button" id="button-8">Back</div>
            <div class="button" id="button-9">Start</div>
          </div>
          <div class="stick-container">
            <div style="text-align: center">
              <div>å·¦æ‘‡æ†</div>
              <div class="stick-visual">
                <div class="stick-dot" id="left-stick"></div>
              </div>
            </div>
            <div style="text-align: center">
              <div>å³æ‘‡æ†</div>
              <div class="stick-visual">
                <div class="stick-dot" id="right-stick"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- é”®ç›˜/é¥æ§å™¨ -->
        <div class="device-section" id="keyboard-section">
          <div class="section-title">âŒ¨ï¸ é”®ç›˜/é¥æ§å™¨</div>
          <div class="status" id="keyboard-status">ç­‰å¾…è¾“å…¥</div>
          <div class="current-key" id="current-key">æŒ‰ä»»æ„é”®</div>
          <div class="key-info" id="key-info">æŒ‰é”®ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>
        </div>

        <!-- æ‰«ç æª -->
        <div class="device-section" id="scanner-section">
          <div class="section-title">ğŸ“± æ‰«ç æª</div>
          <div class="status connected">å°±ç»ª</div>
          <input
            type="text"
            class="scanner-input"
            id="scanner-input"
            placeholder="æ‰«ç ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º..."
            autocomplete="off"
          />
          <div class="scanner-result" id="scanner-result">
            <div style="text-align: center; color: #888">æ‰«ç å†å²è®°å½•</div>
          </div>
        </div>

        <!-- HIDè®¾å¤‡ -->
        <div class="device-section" id="hid-section">
          <div class="section-title">ğŸ”Œ HIDè®¾å¤‡</div>
          <div class="status" id="hid-status">æœªè·å–æƒé™</div>
          <div class="hid-info" id="hid-info">
            <div style="text-align: center; color: #888">
              ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è·å–HIDè®¾å¤‡è®¿é—®æƒé™<br />
              (æ”¯æŒä¸“ä¸šé¥æ§å™¨ã€ç‰¹æ®Šè¾“å…¥è®¾å¤‡ç­‰)
            </div>
          </div>
        </div>
      </div>

      <div class="section-title">ğŸ“ å…¨å±€è¾“å…¥æ—¥å¿—</div>
      <div class="log" id="log"></div>
    </div>

    <script>
      let gamepadIndex = null;
      let animationId = null;
      let lastKeyTime = 0;
      let scanBuffer = "";
      let scanTimer = null;

      // æ—¥å¿—åŠŸèƒ½
      function addLog(message, type = "general") {
        const log = document.getElementById("log");
        const entry = document.createElement("div");
        entry.className = `log-entry log-${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        log.insertBefore(entry, log.firstChild);

        if (log.children.length > 100) {
          log.removeChild(log.lastChild);
        }
      }

      function clearLogs() {
        document.getElementById("log").innerHTML = "";
        addLog("æ—¥å¿—å·²æ¸…ç©º");
      }

      function focusScanner() {
        document.getElementById("scanner-input").focus();
        addLog("æ‰«ç è¾“å…¥æ¡†å·²èšç„¦", "scanner");
      }

      // ==================== æ¸¸æˆæ‰‹æŸ„æ£€æµ‹ ====================
      window.addEventListener("gamepadconnected", (e) => {
        gamepadIndex = e.gamepad.index;
        document.getElementById(
          "gamepad-status"
        ).textContent = `å·²è¿æ¥: ${e.gamepad.id}`;
        document.getElementById("gamepad-status").className =
          "status connected";
        document.getElementById("gamepad-section").classList.add("active");
        addLog(`æ¸¸æˆæ‰‹æŸ„è¿æ¥: ${e.gamepad.id}`, "gamepad");

        if (!animationId) {
          gameLoop();
        }
      });

      window.addEventListener("gamepaddisconnected", (e) => {
        if (e.gamepad.index === gamepadIndex) {
          gamepadIndex = null;
          document.getElementById("gamepad-status").textContent = "æœªè¿æ¥";
          document.getElementById("gamepad-status").className = "status";
          document.getElementById("gamepad-section").classList.remove("active");
          addLog("æ¸¸æˆæ‰‹æŸ„æ–­å¼€è¿æ¥", "gamepad");

          if (animationId) {
            cancelAnimationFrame(animationId);
            animationId = null;
          }
        }
      });

      function gameLoop() {
        if (gamepadIndex === null) return;

        const gamepads = navigator.getGamepads();
        const gamepad = gamepads[gamepadIndex];

        if (!gamepad) {
          gamepadIndex = null;
          return;
        }

        // å¤„ç†æŒ‰é”®
        gamepad.buttons.forEach((button, index) => {
          const buttonElement = document.getElementById(`button-${index}`);
          if (buttonElement) {
            const wasPressed = buttonElement.classList.contains("pressed");
            const isPressed = button.pressed;

            if (isPressed && !wasPressed) {
              buttonElement.classList.add("pressed");
            } else if (!isPressed && wasPressed) {
              buttonElement.classList.remove("pressed");
            }
          }
        });

        // å¤„ç†æ‘‡æ†
        if (gamepad.axes.length >= 4) {
          // å·¦æ‘‡æ†
          const leftX = gamepad.axes[0];
          const leftY = gamepad.axes[1];
          const leftStick = document.getElementById("left-stick");
          const leftPixelX = leftX * 30 + 50;
          const leftPixelY = leftY * 30 + 50;
          leftStick.style.left = `${leftPixelX}%`;
          leftStick.style.top = `${leftPixelY}%`;

          // å³æ‘‡æ†
          const rightX = gamepad.axes[2];
          const rightY = gamepad.axes[3];
          const rightStick = document.getElementById("right-stick");
          const rightPixelX = rightX * 30 + 50;
          const rightPixelY = rightY * 30 + 50;
          rightStick.style.left = `${rightPixelX}%`;
          rightStick.style.top = `${rightPixelY}%`;
        }

        animationId = requestAnimationFrame(gameLoop);
      }

      // ==================== é”®ç›˜/é¥æ§å™¨æ£€æµ‹ ====================
      let keyboardActive = false;

      document.addEventListener("keydown", (e) => {
        // å¦‚æœç„¦ç‚¹åœ¨æ‰«ç è¾“å…¥æ¡†ï¼Œä¸å¤„ç†
        if (
          document.activeElement === document.getElementById("scanner-input")
        ) {
          return;
        }

        if (!keyboardActive) {
          keyboardActive = true;
          document.getElementById("keyboard-section").classList.add("active");
          document.getElementById("keyboard-status").textContent = "æ´»è·ƒä¸­";
          document.getElementById("keyboard-status").className =
            "status connected";
        }

        document.getElementById("current-key").textContent = e.key;
        document.getElementById("key-info").innerHTML = `
                é”®ç : ${e.keyCode} | æŒ‰é”®: ${e.code}<br>
                Ctrl: ${e.ctrlKey} | Alt: ${e.altKey} | Shift: ${e.shiftKey}
            `;

        addLog(
          `é”®ç›˜æŒ‰é”®: ${e.key} (${e.code}) - é”®ç : ${e.keyCode}`,
          "keyboard"
        );

        // é‡ç½®é”®ç›˜æ´»è·ƒçŠ¶æ€çš„å®šæ—¶å™¨
        clearTimeout(window.keyboardTimer);
        window.keyboardTimer = setTimeout(() => {
          keyboardActive = false;
          document
            .getElementById("keyboard-section")
            .classList.remove("active");
          document.getElementById("keyboard-status").textContent = "ç­‰å¾…è¾“å…¥";
          document.getElementById("keyboard-status").className = "status";
          document.getElementById("current-key").textContent = "æŒ‰ä»»æ„é”®";
          document.getElementById("key-info").textContent =
            "æŒ‰é”®ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º";
        }, 3000);
      });

      // ==================== æ‰«ç æªæ£€æµ‹ ====================
      const scannerInput = document.getElementById("scanner-input");
      const scannerResult = document.getElementById("scanner-result");

      scannerInput.addEventListener("input", (e) => {
        const value = e.target.value;

        // æ£€æµ‹å¿«é€Ÿè¾“å…¥ï¼ˆæ‰«ç æªç‰¹å¾ï¼‰
        const now = Date.now();
        if (now - lastKeyTime > 100) {
          // æ–°çš„æ‰«ç å¼€å§‹
          scanBuffer = value;
        } else {
          scanBuffer += value.slice(-1);
        }
        lastKeyTime = now;

        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        clearTimeout(scanTimer);

        // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼Œå¦‚æœ100mså†…æ²¡æœ‰æ–°è¾“å…¥ï¼Œè®¤ä¸ºæ‰«ç å®Œæˆ
        scanTimer = setTimeout(() => {
          if (value.length > 5) {
            // å‡è®¾æ‰«ç ç»“æœé•¿åº¦å¤§äº5
            const entry = document.createElement("div");
            entry.className = "scan-entry";
            entry.innerHTML = `
                        <strong>${new Date().toLocaleTimeString()}</strong><br>
                        ${value}
                    `;
            scannerResult.insertBefore(entry, scannerResult.firstChild);

            addLog(`æ‰«ç ç»“æœ: ${value}`, "scanner");

            // æ¸…ç©ºè¾“å…¥æ¡†
            scannerInput.value = "";

            // é™åˆ¶å†å²è®°å½•æ•°é‡
            if (scannerResult.children.length > 20) {
              scannerResult.removeChild(scannerResult.lastChild);
            }
          }
        }, 100);
      });

      // ==================== HIDè®¾å¤‡æ£€æµ‹ ====================
      async function requestHIDAccess() {
        if (!navigator.hid) {
          addLog("æ­¤æµè§ˆå™¨ä¸æ”¯æŒWebHID API", "hid");
          return;
        }

        try {
          const devices = await navigator.hid.requestDevice({ filters: [] });

          if (devices.length > 0) {
            document.getElementById(
              "hid-status"
            ).textContent = `å·²è¿æ¥ ${devices.length} ä¸ªè®¾å¤‡`;
            document.getElementById("hid-status").className =
              "status connected";
            document.getElementById("hid-section").classList.add("active");

            const hidInfo = document.getElementById("hid-info");
            hidInfo.innerHTML = "";

            devices.forEach((device, index) => {
              const deviceDiv = document.createElement("div");
              deviceDiv.className = "hid-device";
              deviceDiv.innerHTML = `
                            <strong>è®¾å¤‡ ${index + 1}:</strong><br>
                            å‚å•†ID: 0x${device.vendorId
                              .toString(16)
                              .toUpperCase()}<br>
                            äº§å“ID: 0x${device.productId
                              .toString(16)
                              .toUpperCase()}<br>
                            äº§å“å: ${device.productName || "æœªçŸ¥"}<br>
                        `;
              hidInfo.appendChild(deviceDiv);

              addLog(
                `HIDè®¾å¤‡: ${
                  device.productName
                } (VID: 0x${device.vendorId.toString(
                  16
                )}, PID: 0x${device.productId.toString(16)})`,
                "hid"
              );

              // ç›‘å¬HIDè®¾å¤‡è¾“å…¥
              setupHIDDevice(device);
            });
          } else {
            addLog("æœªé€‰æ‹©ä»»ä½•HIDè®¾å¤‡", "hid");
          }
        } catch (error) {
          addLog(`HIDè®¿é—®å¤±è´¥: ${error.message}`, "hid");
        }
      }

      async function setupHIDDevice(device) {
        try {
          await device.open();

          device.addEventListener("inputreport", (event) => {
            const { data, device, reportId } = event;
            const dataArray = new Uint8Array(data.buffer);
            const hexData = Array.from(dataArray)
              .map((b) => b.toString(16).padStart(2, "0"))
              .join(" ");

            addLog(`HIDè¾“å…¥ [${device.productName}]: ${hexData}`, "hid");
          });
        } catch (error) {
          addLog(`æ‰“å¼€HIDè®¾å¤‡å¤±è´¥: ${error.message}`, "hid");
        }
      }

      // ==================== åˆå§‹åŒ– ====================
      window.addEventListener("load", () => {
        // æ£€æŸ¥å·²è¿æ¥çš„æ¸¸æˆæ‰‹æŸ„
        const gamepads = navigator.getGamepads();
        for (let i = 0; i < gamepads.length; i++) {
          if (gamepads[i]) {
            gamepadIndex = i;
            document.getElementById(
              "gamepad-status"
            ).textContent = `å·²è¿æ¥: ${gamepads[i].id}`;
            document.getElementById("gamepad-status").className =
              "status connected";
            document.getElementById("gamepad-section").classList.add("active");
            addLog(`æ£€æµ‹åˆ°æ¸¸æˆæ‰‹æŸ„: ${gamepads[i].id}`, "gamepad");
            gameLoop();
            break;
          }
        }

        // èšç„¦æ‰«ç è¾“å…¥æ¡†
        scannerInput.focus();

        addLog("è¾“å…¥è®¾å¤‡æ£€æµ‹å™¨å·²å¯åŠ¨");
        addLog("æ”¯æŒçš„è®¾å¤‡: æ¸¸æˆæ‰‹æŸ„ã€é”®ç›˜ã€é¥æ§å™¨ã€æ‰«ç æªã€HIDè®¾å¤‡");
      });

      // æ£€æŸ¥WebHIDæ”¯æŒ
      if (!navigator.hid) {
        document.getElementById("hidBtn").disabled = true;
        document.getElementById("hidBtn").textContent = "æµè§ˆå™¨ä¸æ”¯æŒWebHID";
      }
    </script>
  </body>
</html>
